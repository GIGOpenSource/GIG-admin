<template>
  <t-dialog
    v-model:visible="visible"
    :width="600"
    header="ç”¨æˆ·è¯¦æƒ…"
    confirm-btn="ä¿å­˜"
    @cancel="onCancel"
    @confirm="onConfirm"
  >
    <t-tabs :default-value="1">
      <t-tab-panel :value="1" label="ç”¨æˆ·èµ„æ–™">
        <t-form
          ref="formRef"
          :model="data.userProfile"
          label-width="80px"
          :style="{ marginTop: 'var(--td-comp-margin-xxl)' }"
        >
          <t-form-item label="ç”¨æˆ·å" name="username">
            <t-input v-model="data.userProfile.username" class="form-item-content" placeholder="è¾“å…¥ç”¨æˆ·å" />
          </t-form-item>
          <t-form-item label="æ˜µç§°" name="nickname">
            <t-input v-model="data.userProfile.nickname" class="form-item-content" placeholder="è¾“å…¥æ˜µç§°" />
          </t-form-item>
          <!-- <t-form-item label="ç®€ä»‹" name="bio">
            <t-input v-model="data.userProfile.bio" class="form-item-content" placeholder="è¾“å…¥ç®€ä»‹" />
          </t-form-item> -->
          <t-form-item label="ç²‰ä¸é‡" name="followerCount">
            <t-input v-model="data.userProfile.followerCount" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item>
          <t-form-item label="å…³æ³¨" name="followingCount">
            <t-input v-model="data.userProfile.followingCount" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item>
          <!-- <t-form-item label="æ€§åˆ«" name="gender">
            <t-radio-group v-model="data.userProfile.gender" default-value="male">
              <t-radio value="male">{{ GENDER['male'] }}</t-radio>
              <t-radio value="female">{{ GENDER['female'] }}</t-radio>
              <t-radio value="female">{{ GENDER['unknown'] }}</t-radio>
            </t-radio-group>
          </t-form-item>
          <t-form-item label="æŽ¨å¹¿ç " name="inviteCode">
            <t-input v-model="data.userProfile.inviteCode" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item> -->
          <!-- <t-form-item label="å¤´åƒ" name="avatar">
            <t-avatar shape="round" size="large" :image="data.userProfile.avatar" />
          </t-form-item> -->
        </t-form>
      </t-tab-panel>
      <t-tab-panel :value="2" label="ç”¨æˆ·çŠ¶æ€">
        <t-form
          ref="formRef"
          :model="data.userStatus"
          label-width="90px"
          :style="{ marginTop: 'var(--td-comp-margin-xxl)' }"
        >
          <!-- <t-form-item label="VIPçŠ¶æ€" name="username">
            <t-input v-model="data.userStatus.status" class="form-item-content" placeholder="è¾“å…¥ç”¨æˆ·å" />
          </t-form-item> -->
          <t-form-item label="ç”¨æˆ·çŠ¶æ€" name="status">
            <!-- <t-input v-model="data.userStatus.status" class="form-item-content" placeholder="é€‰æ‹©ç”¨æˆ·çŠ¶æ€" /> -->
            <t-select v-model:value="data.userStatus.status" placeholder="é€‰æ‹©è´¦å·çŠ¶æ€">
              <t-option v-for="op in USER_STATUS" :key="op.text" :label="op.text" :value="op.value"></t-option>
            </t-select>
          </t-form-item>
          <t-form-item label="ç”¨æˆ·è§’è‰²" name="member_level">
            <t-select v-model:value="data.userStatus.member_level" placeholder="é€‰æ‹©ç”¨æˆ·è§’è‰²">
              <t-option v-for="op in MEMBER_LEVEL" :key="op.value" :label="op.text" :value="op.value"></t-option>
            </t-select>
          </t-form-item>
          <t-form-item label="é‡‘å¸æ•°é‡" name="gold_coin">
            <t-input
              v-model="data.userStatus.gold_coin"
              class="form-item-content"
              placeholder="è¾“å…¥é‡‘å¸æ•°é‡"
              type="number"
            />
          </t-form-item>
          <!-- <t-form-item label="è®¾å¤‡" name="email">
            <t-input v-model="data.type" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item>
          <t-form-item label="IP" name="email">
            <t-input v-model="data.type" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item> -->
          <!-- <t-form-item label="æ³¨å†Œæ—¶é—´" name="createTime">
            <t-input v-model="data.userStatus.createTime" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item>
          <t-form-item label="æœ€åŽæ´»è·ƒæ—¶é—´" name="lastLoginTime">
            <t-input v-model="data.userStatus.lastLoginTime" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item> -->
          <!-- <t-form-item label="è¢«é‚€è¯·ç " name="email">
            <t-input v-model="data.type" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item> -->
        </t-form>
      </t-tab-panel>
      <t-tab-panel :value="3" label="ç”¨æˆ·è´¦æˆ·">
        <t-form
          ref="formRef"
          :model="data.userAccount"
          label-width="80px"
          :style="{ marginTop: 'var(--td-comp-margin-xxl)' }"
        >
          <t-form-item label="æ‰‹æœºå·" name="phone">
            <t-input v-model="data.userAccount.phone" class="form-item-content" placeholder="è¾“å…¥æ‰‹æœºå·" />
          </t-form-item>
          <!-- <t-form-item label="æ¸ é“ç " name="username">
            <t-input v-model="data.name" class="form-item-content" placeholder="è¾“å…¥ç”¨æˆ·å" />
          </t-form-item>
          <t-form-item label="ç”¨æˆ·ç±»åž‹" name="email">
            <t-input v-model="data.type" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item>
          <t-form-item label="é‡‘å¸ä½™é¢" name="email">
            <t-input v-model="data.type" class="form-item-content" placeholder="è¾“å…¥é‚®ç®±" />
          </t-form-item>
          <t-form-item label="ç§¯åˆ†ä½™é¢" name="username">
            <t-input v-model="data.name" class="form-item-content" placeholder="è¾“å…¥ç”¨æˆ·å" />
          </t-form-item>
          <t-form-item label="ç”¨æˆ·æ ‡ç­¾" name="username">
            <t-input v-model="data.name" class="form-item-content" placeholder="è¾“å…¥ç”¨æˆ·å" />
          </t-form-item> -->
        </t-form>
      </t-tab-panel>
    </t-tabs>
  </t-dialog>
</template>
<script lang="ts" setup>
import { ref, reactive } from 'vue';
import { getUserInfo, editUserInfo } from '@/api/user';
import { GENDER, USER_STATUS, MEMBER_LEVEL } from '@/constants';
import { useFormatDate } from '@/hooks';

const { formatDate } = useFormatDate();
const emit = defineEmits(['confirm']);
const id = ref(0);

const defaultData = {
  userAccount: {
    phone: '',
    email: '',
  },
  userProfile: {
    username: '',
    nickname: '',
    gender: '',
    inviteCode: '',
    avatar: '',
    bio: '',
    followerCount: 0,
    followingCount: 0,
  },
  userStatus: {
    status: '',
    member_level: '',
    gold_coin: 0,
    // lastLoginTime: '',
    // createTime: '',
  },
};

const data = reactive({ ...defaultData });

const visible = ref(false);

const open = (i: number) => {
  id.value = i;
  initData(i);
};

const initData = async (id: number) => {
  console.log(id);
  const res = await getUserInfo(id);
  console.log('ðŸš€ ~ initData ~ res:', res);

  // æ ¼å¼åŒ–æ—¶é—´å­—æ®µ
  if (res.data.date_joined) {
    res.data.date_joined = formatDate(res.data.date_joined);
  }

  // å°† API è¿”å›žçš„æ•°æ®æ˜ å°„åˆ° data å¯¹è±¡
  Object.assign(data, {
    userAccount: {
      phone: res.data.phone || '',
      email: res.data.email || '',
    },
    userProfile: {
      username: res.data.username || '',
      nickname: res.data.user_nickname || '',
      // gender: '', // API ä¸­æ²¡æœ‰æ€§åˆ«å­—æ®µ
      // inviteCode: '', // API ä¸­æ²¡æœ‰æŽ¨å¹¿ç å­—æ®µ
      avatar: res.data.avatar || '',
      bio: res.data.user_bio || '',
      followerCount: res.data.followers_count || 0,
      followingCount: res.data.following_count || 0,
    },
    userStatus: {
      status: res.data.status !== undefined ? String(res.data.status) : '',
      member_level: res.data.member_level || '',
      gold_coin: res.data.gold_coin || 0,
      createTime: res.data.date_joined || '',
      // lastLoginTime: '', // API ä¸­æ²¡æœ‰æœ€åŽç™»å½•æ—¶é—´
    },
  });

  visible.value = true;
};

const onConfirm = async () => {
  const res = await editUserInfo({ ...data.userAccount, ...data.userProfile, ...data.userStatus, id: id.value });
  visible.value = false;
  emit('confirm');
};
const onCancel = () => {
  visible.value = false;
};

defineExpose({
  open,
});
</script>
<style lang="scss" scoped></style>
